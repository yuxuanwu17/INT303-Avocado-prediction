---
title: "INT303 Final project"
author: "Yuxuan Wu 1716309"
date: "December 1, 2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Import the libraries
```{rï¼Œinclude=False}
library(tidyr)
library(skimr)
library(GGally)
library(viridis)
library(caret)
library(e1071)
library(rpart)
library(xgboost)
library(forecast)
library(corrplot)
library(corrgram)
library(ggplot2)
library(ggthemes)
library(psych)
library(scales)
library(treemap)
library(repr)
library(cowplot)
library(magrittr)
library(ggpubr)
library(RColorBrewer)
library(plotrix)
library(ggrepel)
library(tidyverse)
library(gridExtra)
library(lubridate)
library(tibbletime)
library(reshape2)
```
### Load the data and return the head of data
```{r}
df <- read.csv("/Users/yuxuan/Desktop/INT301-Avocado-prediction/avocado-updated-2020.csv")
head(df)
```
### Check whether the dataset contains the missing value
```{r}
sum(is.na(df))
```
The overall dataset do not contain any missing value

### Explore the data and some clarification

#### Explain the features
- date \- The date of the observation
- average_price \- The average price of a single
- total_volume \- Total number of avocados sold
- year \- The year
- type \- conventional or organic
- geography \- The city or region of the observation

#### X4046, X4225, X4770 stands for the PLU code

- Small/Medium Hass Avocado (~3-5oz avocado) | #4046 <br>
- Large Hass Avocado (~8-10oz avocado) | #4225 <br>
- Extra Large Hass Avocado (~10-15oz avocado) | #4770 <br>

### Exploratory Data Analysis

#### Density plot of the difference between two avocadoes.
```{r}
levels(df$type)
```
```{r}
library(ggplot2)
options(repr.plot.width = 8, repr.plot.height = 4)
ggplot(df, aes(x=average_price, fill=type))+
  geom_density()+
  facet_wrap(~type)+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5),legend.position = "bottom")+
  labs(title = "Avocado Price by type")+
  scale_fill_brewer(palette = "Set2")
```

### Create a matrix to demonstrate the volume of conventional and organic avocados
```{r}
library(dplyr)
vol_type <- df %>% group_by(type) %>% summarise(average_volume = round(mean(total_volume),3),average_price = round(mean(average_price),3)) %>% mutate(volume_percent= round(prop.table(average_volume)*100,3))
vol_type
```
**As can be seen from the density plot and the table in avocados.** <br>
- there are two types of avocado: organic and conventional  <br>
- organic avocado share a small percent (3.2%) of volume but has a high price (1.62)  <br>
- conventional avocado share a large percent (96.8) of volume but has a relative low price (1.16) <br>

### Avocado price with the Date

```{r ggplot}
library(ggplot2)
## Change the Date column from factor to the date format
df$date <- as.Date(df$date, "%Y-%m-%d")

## Sort the dates and order the datesets in date
df <- df[order(df$date),]

## Make the plot
df %>% select(date, average_price, type) %>%
  ggplot(aes(x=date,y=average_price))+
  geom_area(aes(color=type,fill=type),alpha=0.3,position=position_dodge(0.8))+
  theme_bw()+
  scale_color_manual(values = c("#ED7921","#62BE51"))+
  scale_fill_manual(values = c("#FD833E","#B8FC5F")
)

```
```{r}
ggplot(data=df, aes(x=date, y=average_price,col=type))+
  geom_line()+
  facet_wrap(~ type)+
  theme_bw()+
  theme(legend.position = "position")
```
### Relationship between Prices and Total on either conventional or organic avocados

#### Filter the data into two categories, conventional or organic

```{r}
organic <- df %>% select(type,average_price,total_volume,date) %>% filter(type=="organic")
#head(organic)
conventional <- df %>% select(type,average_price,total_volume,date) %>% filter(type=="conventional")
#head(conventional)
```

```{r tribble_tabel}
library(tibbletime)
organic <- as_tbl_time(organic,index = date) %>% as_period('1 month')
conventional <- as_tbl_time(conventional,index = date) %>% as_period('monthly')

```

#### Monthly avocados price in either conventional or organic avocados
```{r cowplot}

library(ggplot2)
library(ggthemes)
library(cowplot)

options(repr.plot.width=8, repr.plot.height=6)

## average-price with time series
conventional_monthly <- conventional %>%
    ggplot(aes(x=date,y=average_price))+
    geom_line(color="#5C374C")+
    theme_economist()+
    theme(plot.title = element_text(hjust = 0.5),plot.background = element_rect(fill = "#D5D8DC"))+
    labs(title = "Conventional Avocados")+
    geom_hline(yintercept = max(conventional$average_price),linetype="dashed",color = "red")+
    geom_hline(yintercept = min(conventional$average_price),linetype="dashed",color = "blue")

organic_monthly <- organic %>%
    ggplot(aes(x=date,y=average_price))+
    geom_line(color="#58D68D")+
    theme_economist()+
    theme(plot.title = element_text(hjust = 0.5),plot.background = element_rect(fill = "#D5D8DC"))+
    labs(title = "Organic Avocados")+
    geom_hline(yintercept = max(organic$average_price),linetype="dashed",color = "red")+
    geom_hline(yintercept = min(organic$average_price),linetype="dashed",color = "blue")

## create a volume chart
conventional_volume <- conventional %>%
    ggplot(aes(x=date,y=total_volume))+
    geom_bar(stat = 'identity',fill="#7FB3D5",color="black")+
    theme_economist()+
    theme(plot.title = element_text(hjust = 0.5),plot.background = element_rect(fill = "#D5D8DC"))+
    geom_smooth(method = "loess",color="red")

organic_volume <- organic %>%
    ggplot(aes(x=date,y=total_volume))+
    geom_bar(stat = 'identity',fill='#58D68D',color="black")+
    theme_economist()+
    theme(plot.title = element_text(hjust = 0.5),plot.background = element_rect(fill = "#D5D8DC"))+
    geom_smooth(method = "loess",color ="red")

plot_grid(conventional_monthly,organic_monthly,conventional_volume,organic_volume,nrow = 2,ncol = 2)

#plot_grid(conventional_monthly,conventional_volume,nrow = 2)
```
### Patterns among the years in each month (Autoplot library)

```{r}
## Process the data into year and month format
seasonal_df <- read.csv("/Users/yuxuan/Desktop/INT301-Avocado-prediction/avocado-updated-2020.csv")
seasonal_df$month_year <- format(as.Date(seasonal_df$date),"%Y-%m")
seasonal_df$month <- format(as.Date(seasonal_df$date),"%m")

## Change the month from a Date format into a numerical foramt, then convert to the three letter format
seasonal_df$monthabb <- sapply(seasonal_df$month, function (x) month.abb[as.numeric(x)])
seasonal_df$monthabb <- factor(seasonal_df$monthabb,levels=month.abb)
seasonal_df$monthabb <- factor(seasonal_df$monthabb)

## Set the figure size
options(repr.plot.width=10,repr.plot.height=8)

conv_price <- seasonal_df %>% select(type,year,monthabb,average_price) %>% filter(type=="conventional") %>% group_by(year,monthabb) %>% summarise(avg=mean(average_price))

org_price <- seasonal_df %>% select(type,year,monthabb,average_price) %>% filter(type=="organic") %>% group_by(year,monthabb) %>% summarise(avg=mean(average_price))

conv_price <- ts(conv_price$avg,start = 2015,frequency = 12)
org_price <- ts(org_price$avg,start = 2015,frequency = 12)

byyearplot <- ggseasonplot(conv_price,year.labels = TRUE,year.labels.left = TRUE)+
theme_economist()+
theme(plot.title = element_text(hjust = 0.5),plot.background = element_rect(fill="#D5D8DC"))+
labs(title = "Average conventional Avocados price by year for each month", y="Average Price")+
#scale_fill_manual(values = c("#DA4511", "#FFBD00", "#6A953F", "#9A6233", "#D3AE7C", "#307CA1"))
scale_fill_manual(values = c("#922B21", "#EE865D", "#DDCD5E", "#59BEC4", "#048B9F", "#114676"))

byyearplot
```

### Seasonal patterns analysis
```{r}
ggplot(seasonal_df,aes(x=average_price,fill=as.factor(year)))+
geom_density(alpha=0.5)+
theme_economist()+
facet_wrap(~year)+
theme(plot.title = element_text(hjust = 0.5),plot.background = element_rect(fill="#D5D8DC"))+
guides(fill=FALSE)+
labs(title = "Distribution of Prices by year",x='Average Price',y='Density')+
scale_fill_manual(values = c("#DA4511", "#FFBD00", "#6A953F", "#9A6233", "#D3AE7C", "#307CA1"))

```

### Seasonality patterns

#### Monthly analysis
```{r seaonal patterns}

options(repr.plot.width=10,repr.plot.height=8)
conv_patterns <- seasonal_df %>% select(monthabb,average_price,type) %>% filter(type=="conventional") %>% group_by(monthabb) %>% summarise(avg=mean(average_price)) %>%
  ggplot(aes(x=monthabb, y=avg))+
  geom_point(color="#F35D5D",aes(size=avg))+
  geom_line(group=0)+
  theme_economist()+
  theme(legend.position = "none",plot.title = element_text(hjust = 0.5),plot.background = element_rect(fill="#D5D8DC"))+
  labs(title = "Conventional Avocados",x="Month",y="Average Price")

organic_patterns <- seasonal_df %>% select(monthabb,average_price,type) %>% filter(type=="organic") %>% group_by(monthabb) %>% summarise(avg=mean(average_price)) %>%
ggplot(aes(x=monthabb,y=avg))+
  geom_point(color="#F35D5D",aes(size=avg))+
  geom_line(group=0)+
  theme_economist()+
  theme(legend.position = "none",plot.title = element_text(hjust = 0.5),plot.background = element_rect(fill="#D5D8DC"))+
  labs(title = "Organic Avocados",x="Month",y="Average Price")

whole_patterns <- seasonal_df %>% select(monthabb,average_price,type) %>% group_by(monthabb) %>% summarise(avg=mean(average_price)) %>%
  ggplot(aes(x=monthabb,y=avg))+
  geom_point(color="#F35D5D",aes(size=avg))+
  geom_line(group=0)+
  theme_economist()+
  theme(legend.position = "none",plot.title = element_text(hjust = 0.5),plot.background = element_rect(fill="#D5D8DC"))+
  labs(title = "All Avocados",x="Month",y="Average Price")


plot_grid(conv_patterns,organic_patterns,whole_patterns,nrow = 3)
#conv_patterns
```
#### Seasonal patterns
```{r}
options(repr.plot.width=8,repr.plot.height=6)

## seperate the month into four seasons
seasonal_df$season <- ifelse(seasonal_df$month %in% c("03","04","05"),"Spring",
ifelse(seasonal_df$month %in% c("06","07","08"),"Summer",
ifelse(seasonal_df$month %in% c("09","10","11"),"Autumn","Winter")))

## Prepare to analyze the results
seasonality_plot_conventional_price <- seasonal_df %>% select(season,year,average_price,type) %>% filter(type =="conventional") %>% group_by(season,year) %>% summarise(avg=mean(average_price)) %>%
  ggplot(aes(x=season,y=avg,color=season))+
  geom_segment(aes(x=season,xend=season,y=0,yend=avg))+
  coord_flip()+
  facet_wrap(~as.factor(year))+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5),plot.background = element_rect(fill="#F4F6F7"))+
  labs(title = "Conventional Avocados average price by Season",x="Season",y="Average price")+
  geom_text(aes(x=season,y=0.01,label=paste0("$ ",round(avg,2))),hjust=-0.5,vjust=-0.5,size=4,color="black",fontface='italic',angle=360)

seasonality_plot_conventional_volume <- seasonal_df %>% select(season,year,total_volume,type) %>% filter(type=="conventional") %>% group_by(season,year) %>% summarise(avg=mean(total_volume)) %>%
  ggplot(aes(x=season,y=avg,color=season))+
  geom_segment(aes(x=season,xend=season,y=0,yend=avg))+
  coord_flip()+
  facet_wrap(~as.factor(year))+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5),plot.background = element_rect(fill="#F4F6F7"))+
  labs(title = "Conventional Avocados total volume by Season",x="Season",y="Average volume")+
  geom_text(aes(x=season,y=0.01,label=paste0(round(avg/1000000,2)," m")),hjust=-0.5,vjust=-0.5,size=4,color="black",fontface='italic',angle=360)

plot_grid(seasonality_plot_conventional_price,seasonality_plot_conventional_volume,nrow = 2)

```
```{r}
## Prepare to analyze the results
options(repr.plot.width=8,repr.plot.height=6)

seasonality_plot_organic_price <- seasonal_df %>% select(season,year,average_price,type) %>% filter(type =="organic") %>% group_by(season,year) %>% summarise(avg=mean(average_price)) %>%
  ggplot(aes(x=season,y=avg,color=season))+
  geom_segment(aes(x=season,xend=season,y=0,yend=avg))+
  coord_flip()+
  facet_wrap(~as.factor(year))+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5),plot.background = element_rect(fill="#F4F6F7"))+
  labs(title = "Organic Avocados average price by Season",x="Season",y="Average price")+
  geom_text(aes(x=season,y=0.01,label=paste0("$ ",round(avg,2))),hjust=-0.5,vjust=-0.5,size=4,color="black",fontface='italic',angle=360)

seasonality_plot_organic_volume <- seasonal_df %>% select(season,year,total_volume,type) %>% filter(type=="organic") %>% group_by(season,year) %>% summarise(avg=mean(total_volume)) %>%
  ggplot(aes(x=season,y=avg,color=season))+
  geom_segment(aes(x=season,xend=season,y=0,yend=avg))+
  coord_flip()+
  facet_wrap(~as.factor(year))+
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5),plot.background = element_rect(fill="#F4F6F7"))+
  labs(title = "Organic Avocados total volume by Season",x="Season",y="Average volume")+
  geom_text(aes(x=season,y=0.01,label=paste0(round(avg/1000000,2)," m")),hjust=-0.5,vjust=-0.5,size=4,color="black",fontface='italic',angle=360)

plot_grid(seasonality_plot_organic_price,seasonality_plot_organic_volume,nrow = 2)

```
levels(df$geography)
```{r}
```














